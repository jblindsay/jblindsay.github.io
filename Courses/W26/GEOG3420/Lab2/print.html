<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GEOG3420 W26 Lab 2</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="part1.html"><strong aria-hidden="true">2.</strong> Part 1: Image Histograms</a></li><li class="chapter-item expanded "><a href="part2.html"><strong aria-hidden="true">3.</strong> Part 2: Image Contrast Enhancement</a></li><li class="chapter-item expanded "><a href="part3.html"><strong aria-hidden="true">4.</strong> Part 3: Conversion to Reflectance</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GEOG3420 W26 Lab 2</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="geog3420-remote-sensing-of-the-environment-w26"><a class="header" href="#geog3420-remote-sensing-of-the-environment-w26">GEOG*3420 Remote Sensing of the Environment (W26)</a></h1>
<h2 id="lab-assignment-2-54-marks-total"><a class="header" href="#lab-assignment-2-54-marks-total"><strong>Lab Assignment 2 (54 marks total)</strong></a></h2>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>The purpose of this lab exercise is to introduce students to the techniques involved in the preprocessing of satellite imagery. This includes both the conversion of raw digital numbers (DN) to radiance values, as well as various contrast enhancement techniques used to improve image quality.</p>
<h2 id="readings-and-resources"><a class="header" href="#readings-and-resources">Readings and Resources</a></h2>
<p>The following materials, combined with your textbook (Contrast Enhancement pages 120-129), can be used as background materials and to help in answering the assignment questions.</p>
<ul>
<li>
<p><a href="https://www.usgs.gov/landsat-missions/landsat-9">USGS Landsat 9 Product</a></p>
</li>
<li>
<p><a href="https://homepages.inf.ed.ac.uk/rbf/HIPR2/stretch.htm">Contrast stretching</a></p>
</li>
<li>
<p><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/preface.html">Lindsay, J.B. 2024. The Whitebox Workflows for Python User Manual</a></p>
</li>
</ul>
<h2 id="before-you-begin"><a class="header" href="#before-you-begin">Before you begin</a></h2>
<p><strong>IMPORTANT INFORMATION</strong>: You will need to download the data associated with this lab assignment from the GEOG*3420 CourseLink site. These data, as usual, are quite large. Importantly, while these image may look very similar to the ones used in Lab 1, they are not the same and you will need to download these data to complete this lab exercise.</p>
<h2 id="what-you-need-to-hand-in"><a class="header" href="#what-you-need-to-hand-in">What you need to hand in</a></h2>
<p>You will notice that there are a series of questions embeded in the lab document. These same questions appear in a lab quiz on the CourseLink site. You must complete this quiz as your submission for the assignment before the deadline provided by your TA. <strong>You likely want to prepare your answers to each of the questions in a Word document prior to starting the Lab Quiz</strong>. This way you can copy and paste your completed answers into the Quiz question boxes. There is not time limit on Quiz completion (other than the hard limit of the due date/time), but unfortunately, you will not be able to save your Quiz answers and log back in at a later date, <strong>once you begin the Lab Quiz you will only be able to submit it one time</strong>.</p>
<h2 id="a-note-on-academic-misconduct"><a class="header" href="#a-note-on-academic-misconduct">A note on academic misconduct</a></h2>
<p>The University of Guelph is committed to upholding the highest standards of academic integrity and it is the responsibility of all members of the University community – faculty, staff, and students – to be aware of what constitutes academic misconduct and to do as much as possible to prevent academic offences from occurring. <strong>An example of academic misconduct in this class would be if students shared their answers on a laboratory assignment. While students may work on their lab assignments in groups, they are expected to write their answers to the lab questions independently. Students are also expected to properly reference their answers, using appropriate reference sources. Use of generative AI, even as an information gathering method, is strickly prohibited for this assignment.</strong>  Please note: Whether or not a student intended to commit academic misconduct is not relevant for a finding of guilt. Hurried or careless submission of assignments does not excuse students from responsibility for verifying the academic integrity of their work before submitting it. Students who are in any doubt as to whether an action on their part could be construed as an academic offence should consult with a faculty member or faculty advisor. The Academic Misconduct Policy is outlined in the Undergraduate Calendar.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="part-1-image-histograms"><a class="header" href="#part-1-image-histograms">Part 1: Image Histograms</a></h1>
<p>Using QGIS (or ArcGIS if that is your preference), display the Band 2 (blue) image (<code>LC09_L2SP_018030_20220614_20220616_02_T1_SR_B2</code>), contained in the decompressed Lab 2 data folder, which you should have downloaded from the CourseLink site. You should find the the image looks something like the following:</p>
<p><img src="img/band2.png" alt="band2.tif image" /></p>
<p>This is a similar scene as the imagery that we used in Lab 1, however, it has had some extra processing (it is a Landsat 9 Level-2 image data set compared with the Level-1 data that we used in Lab 1). You may notice that overall this image appears to be quite dark and generally has poor contrast. Image contrast describes the degree to which objects or features within an image can be distinguished in relation to other nearby objects within the scene by their varying brightness. When all of the features in an image are similarly dark, or similarly bright, then the image has poor contrast. Image contrast is one of the most important characteristcs determining the usefulness of an image in visual interpretation (by humans) and the image's overall information content.</p>
<p>When an image appears overall dark with poor contrast, as with our Band 2 image, it is the result of a relatively small number of very bright pixels. The majority of pixels occupy relatively dark radiometric positions, i.e, darker greytones, because of these few very bright pixels. This is very often the result of the presence of cloud cover in the image, clouds being highly reflective throughout much of the spectrum used in Earth observation. However, this is not the case for our scene. Furthermore, the processing used to generate this Landsat 9 Level-2 image can remove some cloud cover. And yet this image still contains some pixels that are much brighter.</p>
<blockquote>
<p>1.1. Inspect the image closely. What broadly defined land-cover type is associated with the very brightest pixels in this scene? Here, adding an OpenStreetMap layer can be helpful in your interpretation. (1 mark)</p>
</blockquote>
<p>Display the Band 2 image's histogram; in QGIS, you would do this by opening the layer properties, selecting the <em>Histogram</em> tab (on the left), and finally pressing the <em>Compute Histogram</em> button. An image histogram shows the frequency distribution of pixel values. You'll notice that the Band 2 image histogram is bimodal, i.e. that it has two peaks.</p>
<blockquote>
<p>1.2. Why do you think that this image histogram is bimodal? What land-cover types are associated with the two peaks in the histogram? (2 marks)</p>
</blockquote>
<p>Another thing that you'll notice about the Band 2 image histogram is that it doesn't occupy the full <em>dynamic range</em>. The dynamic range is a reference to the range in brightness values and is related to the radiometric resolution, or bit-depth of the sensor. In the case of Landsat 9, the OLI-2 sensor has a 14-bit radiometric resolution, meaning that it is capable of producing images with 16384 different greytones. Using the script below apply the Whitebox Workflows <code>raster_summary</code> function to calculate the minimum, maximum, and average digital numbers (DNs) in each of the seven bands of imagery associated with the scene.</p>
<p><em>raster_summary.py</em></p>
<pre><code class="language-python">import os
import whitebox_workflows

wbe = whitebox_workflows.WbEnvironment()  # Initialize Whitebox

try:
    # declare your working directory as a variable
    wbe.working_directory = "/path/to/lab/data" # BE SURE TO UPDATE THIS
    assert(os.path.isdir(wbe.working_directory)) # Check to make sure that your workign directory is a valid directory

    wbe.verbose = False # We don't need constant progress updates for every other tool though

    base_file_name = "LC09_L2SP_018030_20220614_20220616_02_T1_SR_B"

    # We'll transform the first 7 bands of the data set
    for band in range(7): # range counts up to, but not including, the value
        # The bands are indexed 1, 2, 3... but the mult_term list is indexed 0, 1, 2...
        band_num = band + 1
        print(f"\nRaster summary for band {band_num}...")

        image_file = f"{base_file_name}{band_num}.tif" # The name of this file
        band_data = wbe.read_raster(image_file) # Read the file into memory

        print(wbe.raster_summary_stats(band_data))

    # Provide some indication that the job is done.
    print("Operation complete!")

except Exception as e:
    print(f"Exception: {e}")

</code></pre>
<blockquote>
<p>1.3. What are the minimum, maximum, and average DNs for each of the bands of imagery? (7 marks)</p>
<p>1.4. Is the average DN nearer the minimum or the maximum for each of the bands? What does this imply in terms of the contrast of thee images? (2 marks)</p>
</blockquote>
<p>In reality, the minimum and maximum pixel values occupy the extremes of the frequency distribution and there are relatively few cells in these regions of the histograms. This is an important thing to remember for the next section of this lab on contrast enhancements.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="part-2-contrast-enhancement"><a class="header" href="#part-2-contrast-enhancement">Part 2: Contrast Enhancement</a></h1>
<p>Contrast enhancements, sometimes called radiometric enhancements, are a class of image operations that modify the frequency distribution of image values in an effort to optimize the contrast and overall brightness to highlight particular ranges of digital numbers (DNs). The goal of any image enhancement operation is to improve the visualization and interpretation of the data. Contrast enhancement is also an important step in the process of generating a visually appealing colour composite image. If you recall the <code>Balance Contrast Enhancement</code> option that we encountered when we used the <a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#create_colour_composite"><strong>create_colour_composite</strong></a> function, it was performing a type of contrast adjustment internally to ensure that none of the input bands were proportionally brighter than the others.</p>
<p>There are many reasons why the contrast of satellite imagery may be poorly suited to interpretation, including atmospheric scattering and the presence of haze or cloud cover. In this section of the lab assignment, we will try to improve image radiometric quality of imagery through the use of various contrast enhancement tools.</p>
<p><em>Whitebox Workflows</em> (WbW) offers at least six common contrast enhancement methods for use with single-bands of multispectral imagery including:</p>
<ol>
<li><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#gaussian_contrast_stretch"><strong>gaussian_contrast_stretch</strong></a></li>
<li><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#histogram_equalization"><strong>histogram_equalization</strong></a></li>
<li><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#min_max_contrast_stretch"><strong>min_max_contrast_stretch</strong></a></li>
<li><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#percentage_contrast_stretch"><strong>percentage_contrast_stretch</strong></a></li>
<li><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#sigmoidal_contrast_stretch"><strong>sigmoidal_contrast_stretch</strong></a></li>
<li><a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#standard_deviation_contrast_stretch"><strong>standard_deviation_contrast_stretch</strong></a></li>
</ol>
<p>Each of these techniques for performing contrast enhancements offer various advantages and disadvantages that make them applicable under differing image conditions.</p>
<p>First, let's explore the use of the <a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#gaussian_contrast_stretch"><strong>gaussian_contrast_stretch</strong></a> tool. Create a Python script in your Lab 2 folder called <code>contrast.py</code>. Copy the following code into your script file and run it using your development environment (e.g. VS Code). Be sure to modify the <code>wbt.working_directory</code> to point to the folder containing your lab data.</p>
<p><em>contrast.py</em></p>
<pre><code class="language-python">import os
import whitebox_workflows

wbe = whitebox_workflows.WbEnvironment() # Initialize Whitebox

try:
    # declare your working directory as a variable
    wbe.working_directory = "/path/to/lab/data" # BE SURE TO UPDATE THIS
    assert(os.path.isdir(wbe.working_directory))

    base_file_name = "LC09_L2SP_018030_20220614_20220616_02_T1_SR_B"

    # We'll transform the first 7 bands of the data set
    for band in range(7): # range counts up to, but not including, the value
        # The bands are indexed 1, 2, 3... but the mult_term list is indexed 0, 1, 2...
        band_num = band + 1
        print(f"Contrast enhancement for band {band_num}...")

        image_file = f"{base_file_name}{band_num}.tif" # The name of this file
        band_data = wbe.read_raster(image_file) # Read the file into memory

        contrast_enhanced = wbe.gaussian_contrast_stretch(band_data, num_tones=16384)
        wbe.write_raster(contrast_enhanced, f"band{band_num}_gaussian_ce.tif", compress=True)

    print("Operation complete!") # Provide some sort of indication that the job is done.

except Exception as e:
    print(f"Exception: {e}")

</code></pre>
<blockquote>
<p>2.1. Include screenshots of both the resulting Band 2 contrast-stretched image (<code>band2_gaussian_cs.tif</code>) and the associated histogram with your lab hand-in. (2 marks)</p>
<p>2.2. Describe how the histogram of the stretched image compares to the original Band 2 histogram. How has it been modified? (2 marks)</p>
<p>2.3. Compare the contrast of the Gaussian stretched images for several bands to the original iamges. In particular, what objects/land covers are associated with the darkest and the brightest parts of the image? Are you able to distinguish features, such as individual agricultural fields, better in the contrast enhanced image than the original? How much contrast is there between the water (Lake Ontario and Lake Erie) and the surrounding land? Are the streets within urban centres (e.g. Toronto) visible or are they "washed out", i.e. have poor contrast? (5 marks)</p>
</blockquote>
<p>Now try to modify your script to use the <a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#histogram_equalization"><strong>histogram_equalization</strong></a> function instead. Be sure to save the modification as a new file, i.e. perhaps change the saved file name suffix from <code>_gaussian_ce</code> to <code>_histo_eq</code>. Also, generate the histogram for this newly created histogram-equalized images as well. Be sure to examine the help for this tool in the <em>WbW</em> User Manual, so that you are sure you are calling the <code>histogram_equalization()</code> function correctly.</p>
<blockquote>
<p>Include your script for performing the histogram equalization contrast stretch, as well as screenshots of the resulting Band 2 image and histogram, with your lab hand-in. (3 marks for the script + 2 marks for the screenshots = 5 marks)</p>
<p>2.4. Discuss the effects of the histogram equalization contrast stretch on the quality of the image. (5 marks)</p>
</blockquote>
<p>Finally, modify your script again, this time making it apply the <a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#percentage_contrast_stretch"><strong>percentage_contrast_stretch</strong></a>. Use a <em>clip</em> value of 0.5 and be sure to clip both tails of the distribution.</p>
<blockquote>
<p>2.5. Which of the three tested contrast enhancement techniques afforded you the greatest control over the contrast properties of the output image. Be sure to provide justification for your answer. (2 marks)</p>
<p>2.6. How did the shape of the histogram of the percentage contrast stretched image compare with the original image histogram? (2 marks)</p>
</blockquote>
<p>Write a Python script to create true colour composites images (use the <a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/tool_help.html#create_colour_composite"><strong>create_colour_composite</strong></a> function; a true colour composite maps bands 4, 3, and 2 into the RGB channels) for the original and each of the gaussian stretched, histogram equalization stretched, and percentage stretched image sets. Be sure to set the <code>enhance</code> parameter of the <code>create_colour_composite</code> functio to <code>False</code>, which is not its default value. To write this script, I would suggest that you examine the general structure of each of the previous scripts that we've seen thus far in this course. Use the general framework of importing whitebox_workflows, creating the <code>wbe</code> WbEnvironment object, and the <code>try</code>-<code>except</code>-<code>finally</code> structure. Within the <code>try</code> block, you should put the working logic of your code. You will similarly need to set your working directory and other environment variables (e.g. verbose). Next, you will need to read in each of the images needed to create your colour composites, before then providing these images as input parameters to the <strong>create_colour_composite</strong> function (as <code>red</code>, <code>green</code>, and <code>blue</code> parameters; note, the <code>opacity</code> input is optional, and we won't need to set it). Don't forget, you can <a href="https://www.whiteboxgeo.com/manual/wbw-user-manual/book/read-writing-data.html"><strong>read multiple files</strong></a> in at a time like this:</p>
<pre><code class="language-python">band2, band3, band4 = wbe.read_rasters('band2_gaussian_ce.tif', 'band3_gaussian_ce.tif', 'band4_gaussian_ce.tif')
colour_comp = wbe.create_colour_composite(red=band4, green=band3, blue=band2, enhance=False)
</code></pre>
<p>And of course, don't forget to save your colour composites to file (<code>wbe.write_raster</code>).</p>
<blockquote>
<p>Include your script with your lab hand-in. (3 marks)</p>
<p>2.7. Describe the impact of the contrast various contrast enhancement strategies on the colour composite images with respect to their contrast characteristics and the appearance of colours (e.g. to colours appear natural or unnaturals in some of the treatments?). (3 marks)</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="part-3-conversion-of-dns-to-surface-reflectance"><a class="header" href="#part-3-conversion-of-dns-to-surface-reflectance">Part 3: Conversion of DNs to Surface Reflectance</a></h1>
<p>In this lab exercise we have been using a Landsat 9 data set that covers the exact same scene that we used in Lab 1. However, the multispectral imagery data set used here has been processed differently before I acquired it. Specifically, the Lab 1 image data set was a Level-1 (L1TP) Landsat image while the data set used in this lab is a Level-2 (L2) scene.</p>
<blockquote>
<p>3.1. What is the difference between Landsat Level-1 and Level-2 data? (2 mark)</p>
</blockquote>
<p>The raw digital numbers (DNs) contained in the pixels of a satellite image are useful for creating visualizations and for qualitative analysis of the scene. However, before a multispectral image data set can be used for quantiative analysis (e.g. in a land-cover classification) it should be converted into reflectance values. In Lab Exercise 1, we learned that the metadata file distributed with each Landsat scene contains a great deal information about the scene. These metadata also contain the paramters needed to convert the raw DNs into either radiance or reflectance values. Certain remote sensing applications (e.g. applications that require comparing different images of the same site through time or images of different places, or comparing images from different sensors) require the use of calibrated imagery data containing reflectance values. Therefore, it is important to know how to transform the raw imagery into calibrated form.</p>
<blockquote>
<p>3.2. What are the differences between image DNs, radiance values, and reflectance values? (3 marks)</p>
</blockquote>
<p>The process of calibrating raw satellite imagery into reflectance values may include several steps, often including a conversion of DN to radiance, a model for removing the effects of varying illumination within the scene (due to the sun angle, the earth-sun distance, terrain, and clouds and cloud shadows), and an atmospheric correction model. There are varying levels of sophistication that can be used during calibration and the exact process will also vary depending on the exact satellite and sensor. The image data set that we used in Lab 1 was a Level-1 (L1) Landsat 9 image data set. Landsat Level-1 data can be easily converted from their raw DNs into either radiance or top-of-the-atomosphere (TOA) reflectance values using conversion parameters contained in their metadata. TOA relfectance values are suitable for some applications, but many applications will require surface reflectance values, which can only be derived by atmospheric corrections. While this is often an involved process that requires specialized software and knowledge of the condition of the atmosphere at the time the imagery was acquired, fortunately NASA and the USGS provide another tier of Landsat data products that have already been atmospherically corrected, Landsat Level-2 (L2) data.</p>
<blockquote>
<p>3.3 Explain the difference between TOA reflectance and surface reflectance. Why is surface reflectance the best data for change detection applications? (3 marks)</p>
</blockquote>
<p>We are going to examine the basic method used to convert Landsat 9 L2 DNs into surface reflectance values. The basic conversion from digital numbers (DN) to reflectance (ρ) values is:</p>
<blockquote>
<p>ρ<sub>λ</sub> = <em>M</em><sub>λ</sub> * DN + <em>A</em><sub>λ</sub>                                    (Eq. 1)</p>
</blockquote>
<p>where ρ is the transformed reflectance value (at wavelength, λ), <em>M</em> is the band-specific multiplicative rescaling factor, and <em>A</em> is the band-specific additive rescaling factor. <em>M</em> and <em>A</em> can each be found within the metadata file distributed with a Landsat scene.</p>
<p>Open the metadata file associated with the lab data, <code>LC09_L2SP_018030_20220614_20220616_02_T1_MTL.txt</code>, using a text editor (e.g. Notepad, VS Code, etc.). Locate each the reflectance rescaling parameters (e.g. REFLECTANCE_MULT_BAND_1, REFLECTANCE_ADD_BAND_1, etc.) in the file.</p>
<p>We could use Eq. 1 above to convert each of the bands within our scene data set manually. However, this would be a tedious task and the opportunities for using the incorrect parameter by accident is fairly high. Instead, we're going to write a script to automatically read the parameters from the metadata file and then apply the DN-to-reflectance transform to each of our bands. Using <em>VS Code</em>, create a Python script in your Lab 2 folder called <code>reflectance.py</code>. Copy the following code into your script file and run it.</p>
<p><em>relectance.py</em></p>
<pre><code class="language-python">import os
import whitebox_workflows

wbe = whitebox_workflows.WbEnvironment()  # Initialize Whitebox

try:
    # declare your working directory as a variable
    wbe.working_directory = "/path/to/lab/data" # BE SURE TO UPDATE THIS
    assert(os.path.isdir(wbe.working_directory)) # Check to make sure that your workign directory is a valid directory

    base_file_name = "LC09_L2SP_018030_20220614_20220616_02_T1_"

    # These two lists will contain the transformation parameters.
    mult_term = []
    add_term = []
        
    # Open the metadata text file associated with the Landsat scence
    metadata = os.path.join(wbe.working_directory, f"{base_file_name}MTL.txt")
    read_parameters = False
    with open(metadata) as file: # We open the metadata file here
        # Read the file line-by-line looking for the reflectance transformation parameters.
        for line in file:
            if "LEVEL2_SURFACE_REFLECTANCE_PARAMETERS" in line:
                read_parameters = True
            if "END_GROUP = LEVEL2_SURFACE_REFLECTANCE_PARAMETERS" in line:
                read_parameters = False
            if read_parameters: # We must be in the 'LEVEL2_SURFACE_REFLECTANCE_PARAMETERS' block of the file.
                if "REFLECTANCE_MULT_BAND_" in line:
                    # Convert the string to a float and add it to the list.
                    mult_term.append(float(line.split("=")[1].strip()))
                elif "REFLECTANCE_ADD_BAND_" in line:
                    # Convert the string to a float and add it to the list.
                    add_term.append(float(line.split("=")[1].strip()))

    # Let's see what the transformation parameters look like and make sure they're correct.
    print(f"REFLECTANCE_MULT: {mult_term}")
    print(f"REFLECTANCE_ADD: {add_term}")

    # We'll transform the first 5 bands of the data set
    for band in range(5): # range counts up to, but not including, the value
        # The bands are indexed 1, 2, 3... but the mult_term list is indexed 0, 1, 2...
        band_num = band + 1
        print(f"Transforming band {band_num}...")

        image_file = f"{base_file_name}SR_B{band_num}.tif" # The name of this file
        band_data = wbe.read_raster(image_file) # Read the file into memory

        # This is where the DN-to-reflectance transform equation happens.
        reflectance_data = band_data * mult_term[band] + add_term[band]

        # Write the transformed file to disc.
        wbe.write_raster(reflectance_data, f"band{band_num}_reflectance.tif")

    # Provide some sort of indication that the job is done.
    print("Operation complete!")

except Exception as e:
    print(f"Exception: {e}")

</code></pre>
<p>This script may take some time before completing but it will provide you with periodic updates on progress (e.g. <code>Transforming band 1...</code>). Hopefully, the script runs without issue. It is one of the longest scripts that we've seen so far and because it involves reading and parsing text data, there is the potential for system-specific bugs to occur (e.g. if you have the wrong working directory or file names). If you encounter errors when you run the above script, examine the script carefully to see if you can identify the source of the bug. Once you have gained a full understanding of what the script is doing (see the detailed comments), and have exhausted debugging options (e.g. adding print statements in the script to see how far it progresses, searching the Internet for solutions), then you may approach fellow students or the GTA for assistance.</p>
<blockquote>
<p>3.4. Exactly how would you need to alter the above script if you wanted to transform all seven surface reflectance (SR) bands of the Landsat 9 Operational Land Imager (OLI) imagery available for this data set? Identify which line(s) of the script you would need to alter and how. (1 mark)</p>
</blockquote>
<p>Once you have successfully run the script, display each of the five transformed bands using your visualization software. You will notice that they look similar to the original bands, however, their value range is very different. If you click on individual pixel values throughout the image, you'll see that the vast majority of pixels are within the 0-1 range (although some pixels do fall outside this range). Each pixel now contains a reflectance value, expressed as a proportion.</p>
<blockquote>
<p>3.5. Exactly how might you alter the above script if you wanted the reflectance values to be expressed as percentages? (1 mark)</p>
<p>3.6. In QGIS, open the <em>Layer Properties</em> of one of the original band (pre-transformation) images and look at the <em>Information</em> tab (or equivalent in ArcGIS). Now do the same for the corresponding transformed reflectance band image (you may need to close the one properties window before opening the next). How has the transformation changed the file size and the data type? Why do you think this change has occurred? (3 marks)</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
