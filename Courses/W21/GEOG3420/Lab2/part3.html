<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Part 3: Conversion to Reflectance - GEOG3420 W20 Lab 2</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="part1.html"><strong aria-hidden="true">2.</strong> Part 1: Image Histograms</a></li><li><a href="part2.html"><strong aria-hidden="true">3.</strong> Part 2: Image Contrast Enhancement</a></li><li><a href="part3.html" class="active"><strong aria-hidden="true">4.</strong> Part 3: Conversion to Reflectance</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">GEOG3420 W20 Lab 2</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#part-3-conversion-to-top-of-atmosphere-toa-reflectance" id="part-3-conversion-to-top-of-atmosphere-toa-reflectance"><h1>Part 3: Conversion to Top-of-Atmosphere (TOA) Reflectance</h1></a>
<p>In Lab Exercise 1, we learned that the metadata file distributed with each Landsat 8 scene contains information needed to convert the raw and uncalibrated digital numbers (DNs) contained in Landsat band images into either radiance or reflectance values. Certain remote sensing applications (e.g. image classification) require the use of calibrated imagery data containing reflectance values, and sometimes, radiance values. Therefore, it is important to know how to transform the raw imagery into calibrated form.</p>
<blockquote>
<p>3.1. What are the differences between image DNs, radiance values, and reflectance values? (3 marks)</p>
</blockquote>
<p>The process of calibrating raw satellite imagery into reflectance values may include several steps, often including a conversion of DN to radiance, a model for removing the effects of varying illumination within the scene (due to the sun angle, the earth-sun distance, terrain, and clouds and cloud shadows), and an atmospheric correction model. There are varying levels of sophistication that can be used during calibration and exact process will also vary depending on the exact satellite and sensor (Landsat 8 and the OLI sensor in our case). We are going to examine the basic method used to convert Landsat 8 Level 1 DNs into reflectance values. Based on this useful <a href="https://www.usgs.gov/land-resources/nli/landsat/landsat-8?qt-science_support_page_related_con=0#qt-science_support_page_related_con">documentation</a> (<strong>please read this over</strong>), we can see that the basic conversion to top-of-atmosphere reflectance values, including a correction for sun angles, is:</p>
<blockquote>
<p>ρ = (<em>M</em> * DN + <em>A</em>) / sin(θ<sub><em>SE</em></sub>)                        (Eq. 1)</p>
</blockquote>
<p>where ρ is the transformed reflectance value (at a wavelength), <em>M</em> is the band-specific multiplicative rescaling factor, <em>A</em> is the band-specific additive rescaling factor, and θ<sub><em>SE</em></sub> is the sun elevation, in radians. <em>M</em>, <em>A</em>, and θ<sub><em>SE</em></sub> can each be found within the metadata file distributed with a Landsat scene and are specific to the geographic location of the scene and the time that it was acquired.</p>
<blockquote>
<p>3.2. What is difference between the <em>top-of-atmosphere</em> reflectance and <em>surface</em> reflectance? (2 marks)</p>
</blockquote>
<p>Open the metadata file associated with the lab data, <code>LC08_L1TP_018030_20170624_20170713_01_T1_MTL.txt</code>, using a text editor such as VS Code. Try to locate the sun elevation and each the reflectance rescaling parameters in the file.</p>
<blockquote>
<p>3.3. How do the reflectance rescaling parameters compare to the radiance rescaling parameters? What do you think this difference may imply about the pre-processing that was done on the imagery before it was made available? (3 marks)</p>
</blockquote>
<p>We could use Eq. 1 above to convert each of the bands within our scene data set manually. However, this would be a tedious task and the opportunities for using the incorrect parameter by accident is fairly high. Instead, we're going to write a script to automatically read the parameters from the metadata file and then apply the DN-to-reflectance transform to each of our bands. Using <em>VS Code</em>, create a Python script in your Lab 2 folder called <code>reflectance.py</code>. Copy the following code into your script file and run it using the <em>VS Code</em> terminal and <em>don't forget to modify the <code>wbt.work_dir</code> appropriate for your data location</em>.</p>
<pre><code class="language-python">from math import radians, sin
import os
from WBT.whitebox_tools import WhiteboxTools


def main():
    wbt = WhiteboxTools()  # Initialize WhiteboxTools
    wbt.work_dir = os.path.join(os.path.dirname(
        __file__), &quot;lab2_data&quot;)  # Update this
    wbt.verbose = False  # This way the script won't output so many updates about progress

    # Open the metadata text file associated with the Landsat scence
    metadata = os.path.join(
        wbt.work_dir, &quot;LC08_L1TP_018030_20170624_20170713_01_T1_MTL.txt&quot;)
    fh = open(metadata)

    # These two lists will contain the rescaling parameters.
    mult_term = []
    add_term = []
    for line in fh:
        # Read the file line-by-line looking for the reflectance transformation parameters
        if &quot;REFLECTANCE_MULT_BAND_&quot; in line:
            mult_term.append(float(line.split(&quot;=&quot;)[1].strip()))
        elif &quot;REFLECTANCE_ADD_BAND_&quot; in line:
            add_term.append(float(line.split(&quot;=&quot;)[1].strip()))
        elif &quot;SUN_ELEVATION&quot; in line:
            # We're also getting the sun elevation from the metadata. It has
            # to be converted to a float and radians.
            sun_elevation = radians(float(line.split(&quot;=&quot;)[1].strip()))
    fh.close()  # Be sure to close an open file

    # We'll transform the first five bands of the data set
    for i in range(0, 5):
        # The bands are indexed 1, 2, 3... but the mult_term list is indexed 0, 1, 2...
        band_num = i + 1
        print(&quot;Transforming band {}...&quot;.format(band_num))
        inFile = &quot;band{}.tif&quot;.format(
            band_num)
        # This is where the DN-to-reflectance transform equation happens.
        # It creates two temporary rasters that are continually over-written.
        wbt.multiply(inFile, mult_term[i], &quot;tmp1.tif&quot;)
        wbt.add(&quot;tmp1.tif&quot;, add_term[i], &quot;tmp2.tif&quot;)
        # The final transformed raster is called bandX_reflect.tif
        wbt.divide(&quot;tmp2.tif&quot;, sin(sun_elevation),
                   &quot;band{}_reflect.tif&quot;.format(band_num))

    # Provide some sort of indication that the job is done.
    print(&quot;Operation complete!&quot;)


main()

</code></pre>
<p>This script may take a fair bit of time before completing but it will at least provide you with periodic updates on progress (e.g. <code>Transforming band 1...</code>). Hopefully, the script runs without issue for you. It is however one of the longest scripts that we've seen so far and because it involves reading and parsing text data, there is the potential for system-specific bugs to occur. If you encounter errors when you run the above script, examine the script carefully to see if you can identify the source of the bug. Once you have gained a full understanding of what the script is doing (see the detailed comments), and have exhausted debugging options (e.g. adding print statements in the script to see how far it progresses, searching the Internet for solutions), then you may approach fellow students or the GTA for assistance.</p>
<blockquote>
<p>3.4. Exactly how would you need to alter the above script if you had wanted to transform all 9 bands of the Operational Land Imager (OLI) Landsat 8 imagery available for this data set? Identify which line(s) of the script you would need to alter and how. (1 mark)</p>
<p>3.5. What do you think would happen when you run your script if the sun elevation parameter were set to zero in the metadata file? (1 mark)</p>
</blockquote>
<p>Once you have successfully run the script, display each of the five transformed bands using your visualization software. You will notice that they look very similar to the original bands, however, their value range is very different. Each pixel now contains an approximate reflectance value.</p>
<blockquote>
<p>3.6. What are the minimum and maximum values within each of the transformed images. Are these value ranges expected for reflectance data? (6 marks)</p>
<p>3.7. Describe the specific ways that you would need to modify the above script if you wanted to perform a DN-to-<em>radiance</em> transformation instead of the DN-to-<em>reflectance</em> we performed. (Hint: be sure to read over the <a href="https://landsat.usgs.gov/using-usgs-landsat-8-product">documentation</a> before answering.) (4 marks)</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="part2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="part2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
