<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Part 3: Conversion to Reflectance - GEOG3420 W23 Lab 2</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="part1.html"><strong aria-hidden="true">2.</strong> Part 1: Image Histograms</a></li><li class="chapter-item expanded "><a href="part2.html"><strong aria-hidden="true">3.</strong> Part 2: Image Contrast Enhancement</a></li><li class="chapter-item expanded "><a href="part3.html" class="active"><strong aria-hidden="true">4.</strong> Part 3: Conversion to Reflectance</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">GEOG3420 W23 Lab 2</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="part-3-conversion-of-dns-to-surface-reflectance"><a class="header" href="#part-3-conversion-of-dns-to-surface-reflectance">Part 3: Conversion of DNs to Surface Reflectance</a></h1>
<p>In this lab exercise we have been using a Landsat 9 data set that covers the exact same scene that we used in Lab 1. However, the multispectral imagery data set used here has been processed differently before I acquired it. Specifically, the Lab 1 image data set was a Level-1 (L1TP) Landsat image while the data set used in this lab is a Level-2 (L2) scense.</p>
<blockquote>
<p>3.1. What is the difference between Landsat Level-1 and Level-2 data? (2 mark)</p>
</blockquote>
<p>The raw digital numbers (DNs) contained in the pixels of a satellite image are useful for creating visualizations and for qualitative analysis of the scene. However, before a multispectral image data set can be used for quantiative analysis (e.g. in a land-cover classification) it should be converted into reflectance values. In Lab Exercise 1, we learned that the metadata file distributed with each Landsat scene contains a great deal information about the scene. These metadata also contain the paramters needed to convert the raw DNs into either radiance or reflectance values. Certain remote sensing applications (e.g. applications that require comparing different images of the same site through time or images of different places, or comparing images from different sensors) require the use of calibrated imagery data containing reflectance values. Therefore, it is important to know how to transform the raw imagery into calibrated form.</p>
<blockquote>
<p>3.2. What are the differences between image DNs, radiance values, and reflectance values? (3 marks)</p>
</blockquote>
<p>The process of calibrating raw satellite imagery into reflectance values may include several steps, often including a conversion of DN to radiance, a model for removing the effects of varying illumination within the scene (due to the sun angle, the earth-sun distance, terrain, and clouds and cloud shadows), and an atmospheric correction model. There are varying levels of sophistication that can be used during calibration and the exact process will also vary depending on the exact satellite and sensor. The image data set that we used in Lab 1 was a Level-1 (L1) Landsat 9 image data set. Landsat Level-1 data can be easily converted from their raw DNs into either radiance or top-of-the-atomosphere (TOA) reflectance values using conversion parameters contained in their metadata. TOA relfectance values are suitable for some applications, but many applications will require surface reflectance values, which can only be derived by atmospheric corrections. While this is often an involved process that requires specialized software and knowledge of the condition of the atmosphere at the time the imagery was acquired, fortunately NASA and the USGS provide another tier of Landsat data products that have already been atmospherically corrected, Landsat Level-2 (L2) data.</p>
<blockquote>
<p>3.3 Explain the difference between TOA reflectance and surface reflectance. Why is surface reflectance the best data for change detection applications? (3 marks)</p>
</blockquote>
<p>We are going to examine the basic method used to convert Landsat 9 L2 DNs into surface reflectance values. The basic conversion from digital numbers (DN) to reflectance (ρ) values is:</p>
<blockquote>
<p>ρ<sub>λ</sub> = <em>M</em><sub>λ</sub> * DN + <em>A</em><sub>λ</sub>                                    (Eq. 1)</p>
</blockquote>
<p>where ρ is the transformed reflectance value (at wavelength, λ), <em>M</em> is the band-specific multiplicative rescaling factor, and <em>A</em> is the band-specific additive rescaling factor. <em>M</em> and <em>A</em> can each be found within the metadata file distributed with a Landsat scene.</p>
<p>Open the metadata file associated with the lab data, <code>LC09_L2SP_018030_20220614_20220616_02_T1_MTL.txt</code>, using a text editor (e.g. Notepad, VS Code, etc.). Locate each the reflectance rescaling parameters (e.g. REFLECTANCE_MULT_BAND_1, REFLECTANCE_ADD_BAND_1, etc.) in the file.</p>
<p>We could use Eq. 1 above to convert each of the bands within our scene data set manually. However, this would be a tedious task and the opportunities for using the incorrect parameter by accident is fairly high. Instead, we're going to write a script to automatically read the parameters from the metadata file and then apply the DN-to-reflectance transform to each of our bands. Using <em>VS Code</em>, create a Python script in your Lab 2 folder called <code>reflectance.py</code>. Copy the following code into your script file and run it and <strong>don't forget to update the working directory to reflect your data location as well as the <code>floating-license-ID</code> (in both locations)</strong>.</p>
<p><em>relectance.py</em></p>
<pre><code class="language-python">import os
import whitebox_workflows

wbe = whitebox_workflows.WbEnvironment(&quot;floating-license-ID&quot;)  # Initialize Whitebox

try:
    # declare your working directory as a variable
    wbe.working_directory = &quot;/path/to/lab/data&quot; # BE SURE TO UPDATE THIS
    assert(os.path.isdir(wbe.working_directory)) # Check to make sure that your workign directory is a valid directory

    base_file_name = &quot;LC09_L1TP_018030_20220614_20220615_02_T1_&quot;

    # These two lists will contain the transformation parameters.
    mult_term = []
    add_term = []
        
    # Open the metadata text file associated with the Landsat scence
    metadata = os.path.join(wbe.working_directory, f&quot;{base_file_name}MTL.txt&quot;)
    read_parameters = False
    with open(metadata) as file: # We open the metadata file here
        # Read the file line-by-line looking for the reflectance transformation parameters.
        for line in file:
            if &quot;LEVEL2_SURFACE_REFLECTANCE_PARAMETERS&quot; in line:
                read_parameters = True
            if &quot;END_GROUP = LEVEL2_SURFACE_REFLECTANCE_PARAMETERS&quot; in line:
                read_parameters = False
            if read_parameters: # We must be in the 'LEVEL2_SURFACE_REFLECTANCE_PARAMETERS' block of the file.
                if &quot;REFLECTANCE_MULT_BAND_&quot; in line:
                    # Convert the string to a float and add it to the list.
                    mult_term.append(float(line.split(&quot;=&quot;)[1].strip()))
                elif &quot;REFLECTANCE_ADD_BAND_&quot; in line:
                    # Convert the string to a float and add it to the list.
                    add_term.append(float(line.split(&quot;=&quot;)[1].strip()))

    # Let's see what the transformation parameters look like and make sure they're correct.
    print(f&quot;REFLECTANCE_MULT: {mult_term}&quot;)
    print(f&quot;REFLECTANCE_ADD: {add_term}&quot;)

    # We'll transform the first 5 bands of the data set
    for band in range(5): # range counts up to, but not including, the value
        # The bands are indexed 1, 2, 3... but the mult_term list is indexed 0, 1, 2...
        band_num = band + 1
        print(f&quot;Transforming band {band_num}...&quot;)

        image_file = f&quot;{base_file_name}B{band_num}.tif&quot; # The name of this file
        band_data = wbe.read_raster(image_file) # Read the file into memory

        # This is where the DN-to-reflectance transform equation happens.
        reflectance_data = band_data * mult_term[band] + add_term[band]

        # Write the transformed file to disc.
        wbe.write_raster(reflectance_data, f&quot;band{band_num}_reflectance.tif&quot;)

    # Provide some sort of indication that the job is done.
    print(&quot;Operation complete!&quot;)

except Exception as e:
    print(f&quot;Exception: {e}&quot;)

finally:
    print(wbe.check_in_license(&quot;floating-license-ID&quot;))
</code></pre>
<p>This script may take some time before completing but it will provide you with periodic updates on progress (e.g. <code>Transforming band 1...</code>). Hopefully, the script runs without issue. It is one of the longest scripts that we've seen so far and because it involves reading and parsing text data, there is the potential for system-specific bugs to occur (e.g. if you have the wrong working directory or file names). If you encounter errors when you run the above script, examine the script carefully to see if you can identify the source of the bug. Once you have gained a full understanding of what the script is doing (see the detailed comments), and have exhausted debugging options (e.g. adding print statements in the script to see how far it progresses, searching the Internet for solutions), then you may approach fellow students or the GTA for assistance.</p>
<blockquote>
<p>3.4. Exactly how would you need to alter the above script if you wanted to transform all seven surface reflectance (SR) bands of the Landsat 9 Operational Land Imager (OLI) imagery available for this data set? Identify which line(s) of the script you would need to alter and how. (1 mark)</p>
</blockquote>
<p>Once you have successfully run the script, display each of the five transformed bands using your visualization software. You will notice that they look similar to the original bands, however, their value range is very different. If you click on individual pixel values throughout the image, you'll see that the vast majority of pixels are within the 0-1 range (although some pixels do fall outside this range). Each pixel now contains a reflectance value, expressed as a proportion. </p>
<blockquote>
<p>3.5. Exactly how might you alter the above script if you wanted the reflectance values to be expressed as percentages? (1 mark)</p>
<p>3.6. In QGIS, open the <em>Layer Properties</em> of one of the original band (pre-transformation) images and look at the <em>Information</em> tab (or equivalent in ArcGIS). Now do the same for the corresponding transformed reflectance band image (you may need to close the one properties window before opening the next). How has the transformation changed the file size and the data type? Why do you think this change has occurred? (3 marks)</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="part2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="part2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
